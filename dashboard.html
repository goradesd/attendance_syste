<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
    let videoStream;

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { 
                videoStream = stream; 
                document.getElementById('video').srcObject = stream; 
            })
            .catch(() => alert("âŒ Camera access denied!"));
    }

    function captureAndSend() {
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        canvas.width = 320; 
        canvas.height = 240;
        canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
        const photo = canvas.toDataURL('image/jpeg');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                sendAttendance(pos.coords.latitude, pos.coords.longitude, photo);
            }, () => {
                // Fallback if location denied
                alert("âŒ Location access denied! Using default coordinates (Pune).");
                sendAttendance(18.5204, 73.8567, photo); // Pune coordinates
            });
        } else {
            alert("Geolocation not supported. Using default coordinates.");
            sendAttendance(18.5204, 73.8567, photo);
        }
    }

    function sendAttendance(lat, lon, photo) {
        fetch("/checkin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                latitude: lat,
                longitude: lon,
                photo: photo
            })
        })
        .then(r => r.json())
        .then(res => {
            document.getElementById("msg").innerText = res.message;
            stopCamera();
        })
        .catch(() => {
            alert("âš ï¸ Error sending attendance!");
        });
    }

    function stopCamera() {
        if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    }

    window.onload = startCamera;
    </script>
</head>
<body class="text-center mt-5">
    <h2>Welcome, {{ name }}</h2>
    <video id="video" width="320" height="240" autoplay class="border rounded mt-3"></video><br>
    <button class="btn btn-success mt-3" onclick="captureAndSend()">ðŸ“¸ Mark Attendance</button>
    <p id="msg" class="mt-4 text-primary fw-bold"></p>
    <a href="/logout" class="btn btn-outline-danger mt-4">Logout</a>
</body>
</html>
